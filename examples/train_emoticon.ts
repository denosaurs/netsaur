import { CPU } from "../backends/cpu/mod.ts";
import { DataType, DataTypeArray } from "../deps.ts";
import {
  DenseLayer,
  SigmoidLayer,
  NeuralNetwork,
  setupBackend,
  tensor1D,
  tensor2D,
} from "../mod.ts";

const character = (string: string) =>
  Array.from(string.trim().split("").map(integer));

const integer = (character: string): number => character === "#" ? 1 : 0;

const happy = character(
  "....................#################...................." +
    "...............######...............######..............." +
    "...........####...........................####..........." +
    "........####.................................###........." +
    "......###.......................................###......" +
    ".....##...........###...............###...........##....." +
    "...##...........#######...........#######..........###..." +
    "..##............#######...........#######............##.." +
    ".##.............#######...........#######.............##." +
    ".##...............###...............###...............##." +
    "##.....................................................##" +
    "##.....................................................##" +
    "##.....................................................##" +
    ".##...................................................##." +
    ".##......##...................................##......##." +
    "..##.......###.............................###.......##.." +
    "...###.......####.......................####.......###..." +
    ".....##.........######.............######.........##....." +
    "......###............###############............###......" +
    "........####.................................####........" +
    "...........####...........................####..........." +
    "...............######...............######..............." +
    "....................#################....................",
);
const sad = character(
  "....................#################...................." +
    "...............######...............######..............." +
    "...........####...........................####..........." +
    "........####.................................###........." +
    "......###.......................................###......" +
    ".....##...........###...............###...........##....." +
    "...##...........#######...........#######..........###..." +
    "..##............#######...........#######............##.." +
    ".##.............#######...........#######.............##." +
    ".##...............###...............###...............##." +
    "##.....................................................##" +
    "##.....................................................##" +
    "##.....................................................##" +
    ".##...................................................##." +
    ".##.................#################.................##." +
    "..##............####..................####...........##.." +
    "...###.......####.......................####.......###..." +
    ".....##....###..............................###....##...." +
    "......#####....................................#####....." +
    "........####.................................####........" +
    "...........####...........................####..........." +
    "...............######...............######..............." +
    "....................#################....................",
);

await setupBackend(CPU);

const net = new NeuralNetwork({
  silent: true,
  layers: [
    DenseLayer({ size: [10] }),
    SigmoidLayer(),
    DenseLayer({ size: [1] }),
    SigmoidLayer(),
  ],
  cost: "crossentropy",
});

await net.train(
  [
    {
      inputs: tensor2D([happy]),
      outputs: tensor1D(["a".charCodeAt(0) / 255]),
    },
    {
      inputs: tensor2D([sad]),
      outputs: tensor1D(["b".charCodeAt(0) / 255]),
    },
  ],
  10000,
);

console.log(toChar((await net.predict(tensor1D(happy))).data)); // ðŸ˜€
console.log(toChar((await net.predict(tensor1D(sad))).data)); // ðŸ˜”

function toChar<T extends DataType>(x: DataTypeArray<T>) {
  const str = String.fromCharCode(Math.round(x[0] * 255));
  return str === "a" ? "ðŸ˜€" : str === "b" ? "ðŸ˜”" : str;
}
